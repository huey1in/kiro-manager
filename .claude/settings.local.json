{
  "permissions": {
    "allow": [
      "Bash(wc -l \"C:\\\\Users\\\\29269\\\\Downloads\\\\kiro manager\\\\src\"/*.ts)",
      "Bash(ls -lh \"C:\\\\Users\\\\29269\\\\Downloads\\\\kiro manager\\\\src\"/*.ts)",
      "Bash(\"C:\\\\Users\\\\29269\\\\Downloads\\\\kiro manager\\\\src\\\\actions\\\\account-actions.ts\" << 'EOF'\n// 账号操作模块\nimport type { Account } from '../types'\nimport { accountStore } from '../store'\n\n/**\n * 刷新账号信息\n */\nexport async function refreshAccount\\(account: Account, onUpdate?: \\(accountId: string\\) => Promise<void>\\): Promise<void> {\n  if \\(!account.credentials.refreshToken || !account.credentials.clientId || !account.credentials.clientSecret\\) {\n    window.UI?.toast.error\\('账号缺少刷新凭证'\\)\n    throw new Error\\('账号缺少刷新凭证'\\)\n  }\n\n  window.UI?.toast.info\\(`正在刷新账号: ${account.email}`\\)\n\n  try {\n    const result = await \\(window as any\\).__TAURI__.core.invoke\\('verify_account_credentials', {\n      refreshToken: account.credentials.refreshToken,\n      clientId: account.credentials.clientId,\n      clientSecret: account.credentials.clientSecret,\n      region: account.credentials.region || 'us-east-1'\n    }\\)\n\n    if \\(result.success && result.data\\) {\n      const now = Date.now\\(\\)\n      accountStore.updateAccount\\(account.id, {\n        email: result.data.email,\n        userId: result.data.user_id,\n        credentials: {\n          ...account.credentials,\n          accessToken: result.data.access_token,\n          refreshToken: result.data.refresh_token,\n          expiresAt: now + \\(result.data.expires_in || 3600\\) * 1000\n        },\n        subscription: {\n          type: result.data.subscription_type,\n          title: result.data.subscription_title,\n          daysRemaining: result.data.days_remaining\n        },\n        usage: {\n          current: result.data.usage.current,\n          limit: result.data.usage.limit,\n          percentUsed: result.data.usage.current / result.data.usage.limit,\n          lastUpdated: now,\n          nextResetDate: result.data.next_reset_date\n        },\n        status: 'active',\n        lastUsedAt: now\n      }\\)\n\n      // 如果提供了更新回调，调用它\n      if \\(onUpdate\\) {\n        await onUpdate\\(account.id\\)\n      }\n\n      window.UI?.toast.success\\('账号刷新成功'\\)\n    } else {\n      window.UI?.toast.error\\(result.error || '刷新失败'\\)\n      throw new Error\\(result.error || '刷新失败'\\)\n    }\n  } catch \\(error\\) {\n    window.UI?.toast.error\\('刷新失败: ' + \\(error as Error\\).message\\)\n    throw error\n  }\n}\n\n/**\n * 删除账号\n */\nexport function deleteAccount\\(accountId: string, onDelete?: \\(accountId: string\\) => void\\): void {\n  const accounts = accountStore.getAccounts\\(\\)\n  const account = accounts.find\\(a => a.id === accountId\\)\n  if \\(!account\\) return\n\n  if \\(confirm\\(`确定要删除账号 ${account.email} 吗？`\\)\\) {\n    accountStore.deleteAccount\\(accountId\\)\n    if \\(onDelete\\) {\n      onDelete\\(accountId\\)\n    }\n    window.UI?.toast.success\\('账号已删除'\\)\n  }\n}\n\n/**\n * 批量检查账号状态\n */\nexport async function handleBatchCheck\\(selectedIds: Set<string>\\): Promise<void> {\n  const selectedAccounts = accountStore.getAccounts\\(\\).filter\\(a => selectedIds.has\\(a.id\\)\\)\n\n  if \\(selectedAccounts.length === 0\\) {\n    window.UI?.toast.warning\\('请先选择要检查的账号'\\)\n    return\n  }\n\n  window.UI?.toast.info\\(`正在检查 ${selectedAccounts.length} 个账号状态...`\\)\n\n  let successCount = 0\n  let failedCount = 0\n\n  for \\(const account of selectedAccounts\\) {\n    if \\(!account.credentials.refreshToken || !account.credentials.clientId || !account.credentials.clientSecret\\) {\n      failedCount++\n      accountStore.updateAccount\\(account.id, { status: 'error', lastError: '缺少凭证信息' }\\)\n      continue\n    }\n\n    try {\n      // 只验证凭证是否有效，不更新详细信息\n      const result = await \\(window as any\\).__TAURI__.core.invoke\\('verify_account_credentials', {\n        refreshToken: account.credentials.refreshToken,\n        clientId: account.credentials.clientId,\n        clientSecret: account.credentials.clientSecret,\n        region: account.credentials.region || 'us-east-1',\n        authMethod: account.credentials.authMethod || 'IdC',\n        provider: account.credentials.provider || account.idp\n      }\\)\n\n      if \\(result.success\\) {\n        accountStore.updateAccount\\(account.id, {\n          status: 'active',\n          lastError: undefined\n        }\\)\n        successCount++\n      } else {\n        accountStore.updateAccount\\(account.id, {\n          status: 'error',\n          lastError: result.error || '验证失败'\n        }\\)\n        failedCount++\n      }\n    } catch \\(error\\) {\n      accountStore.updateAccount\\(account.id, {\n        status: 'error',\n        lastError: \\(error as Error\\).message\n      }\\)\n      failedCount++\n    }\n  }\n\n  if \\(failedCount === 0\\) {\n    window.UI?.toast.success\\(`检查完成：${successCount} 个账号状态正常`\\)\n  } else {\n    window.UI?.toast.warning\\(`检查完成：${successCount} 个正常，${failedCount} 个异常`\\)\n  }\n}\n\n/**\n * 批量刷新账号\n */\nexport async function handleBatchRefresh\\(selectedIds: Set<string>, onUpdate?: \\(accountId: string\\) => Promise<void>\\): Promise<void> {\n  const selectedAccounts = accountStore.getAccounts\\(\\).filter\\(a => selectedIds.has\\(a.id\\)\\)\n\n  if \\(selectedAccounts.length === 0\\) {\n    window.UI?.toast.warning\\('请先选择要刷新的账号'\\)\n    return\n  }\n\n  window.UI?.toast.info\\(`正在刷新 ${selectedAccounts.length} 个账号...`\\)\n\n  let successCount = 0\n  let failedCount = 0\n\n  for \\(const account of selectedAccounts\\) {\n    try {\n      await refreshAccount\\(account, onUpdate\\)\n      successCount++\n    } catch \\(error\\) {\n      failedCount++\n    }\n  }\n\n  if \\(failedCount === 0\\) {\n    window.UI?.toast.success\\(`刷新完成：${successCount} 个账号已更新`\\)\n  } else {\n    window.UI?.toast.warning\\(`刷新完成：${successCount} 个成功，${failedCount} 个失败`\\)\n  }\n}\n\n/**\n * 批量删除账号\n */\nexport function handleBatchDelete\\(selectedIds: Set<string>, onClear: \\(\\) => void\\): void {\n  const selectedCount = selectedIds.size\n\n  if \\(selectedCount === 0\\) {\n    window.UI?.toast.warning\\('请先选择要删除的账号'\\)\n    return\n  }\n\n  if \\(confirm\\(`确定要删除选中的 ${selectedCount} 个账号吗？此操作不可恢复。`\\)\\) {\n    selectedIds.forEach\\(id => {\n      accountStore.deleteAccount\\(id\\)\n    }\\)\n    onClear\\(\\)\n    window.UI?.toast.success\\(`已删除 ${selectedCount} 个账号`\\)\n  }\n}\nEOF)",
      "Bash(python3 << 'PYTHON_SCRIPT'\nimport re\n\n# 读取原文件\nwith open\\(r\"C:\\\\Users\\\\29269\\\\Downloads\\\\kiro manager\\\\src\\\\account-manager.ts\", \"r\", encoding=\"utf-8\"\\) as f:\n    content = f.read\\(\\)\n\n# 1. 更新导入语句\nold_imports = \"\"\"import type { Account } from './types'\nimport { accountStore } from './store'\"\"\"\n\nnew_imports = \"\"\"import type { Account } from './types'\nimport { accountStore } from './store'\nimport { renderAccountCard, renderAccountListItem } from './renderers/account-card'\nimport { renderFilterPanel } from './renderers/filter-panel'\nimport { showExportDialog } from './dialogs/export-dialog'\nimport { showAddAccountDialog } from './dialogs/add-account-dialog'\nimport { showEditAccountDialog } from './dialogs/edit-account-dialog'\nimport { showAccountDetailDialog } from './dialogs/detail-dialog'\nimport { getSubscriptionColor, getStatusText, getIdpDisplayName } from './utils/account-utils'\nimport { refreshAccount, deleteAccount, handleBatchCheck, handleBatchRefresh, handleBatchDelete } from './actions/account-actions'\"\"\"\n\ncontent = content.replace\\(old_imports, new_imports\\)\n\n# 2. 删除 renderAccountCard 方法 \\(保留调用它的地方\\)\n# 找到方法定义并删除\ncontent = re.sub\\(\n    r'  private renderAccountCard\\\\\\(account: Account\\\\\\): string \\\\{[\\\\s\\\\S]*?^  \\\\}',\n    '',\n    content,\n    flags=re.MULTILINE\n\\)\n\n# 3. 删除 renderAccountListItem 方法\ncontent = re.sub\\(\n    r'  private renderAccountListItem\\\\\\(account: Account\\\\\\): string \\\\{[\\\\s\\\\S]*?^  \\\\}',\n    '',\n    content,\n    flags=re.MULTILINE\n\\)\n\n# 4. 删除 getSubscriptionColor 方法\ncontent = re.sub\\(\n    r'  private getSubscriptionColor\\\\\\(type: string\\\\\\): string \\\\{[\\\\s\\\\S]*?^  \\\\}',\n    '',\n    content,\n    flags=re.MULTILINE\n\\)\n\n# 5. 删除 getStatusText 方法\ncontent = re.sub\\(\n    r'  private getStatusText\\\\\\(status: string\\\\\\): string \\\\{[\\\\s\\\\S]*?^  \\\\}',\n    '',\n    content,\n    flags=re.MULTILINE\n\\)\n\n# 6. 删除 renderFilterPanel 方法\ncontent = re.sub\\(\n    r'  private renderFilterPanel\\\\\\(\\\\\\): string \\\\{[\\\\s\\\\S]*?^  \\\\}',\n    '',\n    content,\n    flags=re.MULTILINE\n\\)\n\nprint\\(\"Step 1: Removed rendering methods\"\\)\n\n# 写入临时文件以检查\nwith open\\(r\"C:\\\\Users\\\\29269\\\\Downloads\\\\kiro manager\\\\src\\\\account-manager-temp.ts\", \"w\", encoding=\"utf-8\"\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Temporary file created for inspection\"\\)\nprint\\(f\"New file length: {len\\(content.splitlines\\(\\)\\)} lines\"\\)\n\nPYTHON_SCRIPT)",
      "Bash(npm run build)",
      "Bash(python3 -c \"\nimport re\n\n# 读取文件\nwith open\\(''C:/Users/29269/Downloads/kiro manager/src/account-manager.ts'', ''r'', encoding=''utf-8''\\) as f:\n    lines = f.readlines\\(\\)\n\n# 需要删除的方法名\nmethods_to_remove = [\n    ''showAccountDetailDialog'',\n    ''refreshAccount'', \n    ''showAddAccountDialog'',\n    ''showEditAccountDialog'',\n    ''deleteAccount'',\n    ''handleBatchCheck'',\n    ''handleBatchRefresh'',\n    ''handleBatchDelete'',\n    ''showExportDialog''\n]\n\n# 找到每个方法的起始和结束位置\ni = 0\nnew_lines = []\nskip_until = -1\n\nwhile i < len\\(lines\\):\n    if i < skip_until:\n        i += 1\n        continue\n        \n    line = lines[i]\n    \n    # 检查是否是要删除的方法\n    should_skip = False\n    for method in methods_to_remove:\n        if f''private {method}\\('' in line:\n            # 找到方法结束位置（匹配的右大括号）\n            brace_count = 0\n            started = False\n            end_line = i\n            \n            for j in range\\(i, len\\(lines\\)\\):\n                for char in lines[j]:\n                    if char == ''{'':\n                        brace_count += 1\n                        started = True\n                    elif char == ''}'':\n                        brace_count -= 1\n                        if started and brace_count == 0:\n                            end_line = j\n                            break\n                if started and brace_count == 0:\n                    break\n            \n            skip_until = end_line + 1\n            should_skip = True\n            print\\(f''删除方法 {method}: 行 {i+1} 到 {end_line+1}''\\)\n            break\n    \n    if not should_skip:\n        new_lines.append\\(line\\)\n    \n    i += 1\n\n# 写回文件\nwith open\\(''C:/Users/29269/Downloads/kiro manager/src/account-manager.ts'', ''w'', encoding=''utf-8''\\) as f:\n    f.writelines\\(new_lines\\)\n\nprint\\(f''完成！从 {len\\(lines\\)} 行减少到 {len\\(new_lines\\)} 行''\\)\n\")",
      "Bash(node remove-methods.js)",
      "Bash(find src/actions src/dialogs src/renderers src/utils -name \"*.ts\" -exec wc -l {} ;)",
      "Bash(find src/styles -name \"*.css\" -exec wc -l {} ;)",
      "Bash(npm run check)",
      "Bash(while read f)",
      "Bash(done)",
      "Bash(npx tsc --noEmit)"
    ]
  }
}
